# スイッチ(switch)

```{tip}
もちろん某社のゲーム機ではありません
```

スイッチは、MACを利用したネットワークの中継装置であり、データリンクを考える際に重要となる機材です。

## スイッチとハブ

スイッチは、複数のポートを持ち、各ポートに接続されたデバイス同士を接続するための機器です。
スイッチは、MACアドレスを利用して、データを適切なポートに転送します。

なお、同様のもので、ハブがありますが、こちらは物理層(レイヤー1)に関わる装置で、10BASE-T時代に使われていたものとして区別されます。

- ハブ(レイヤー1)
    - 物理層の装置
    - 受信したデータ(電気信号)を増幅して、残りのポートに送信する
- スイッチ(レイヤー2)
    - データリンク層の装置
    - 受信したデータをMACアドレスを元に、適切なポートに転送する
    - ユニキャストであれば1つのポートに、マルチキャスト(ブロードキャスト)は複数ポートに転送する

```{note}
一般的にはスイッチも込みで『ハブ』と表現されるため、**スイッチングハブ**と読んで区別することがあります。

また、ハブ(L1)に関しては、ほぼ何も考えずに他ポートに転送することから**バカハブ**と揶揄されることがあります。
もちろん俗語であり、あまりおおっぴらにしない方がいい表現ですが、ネットワークの仕事をするときにはなにげに通じます。
```

## スイッチの構造

スイッチは構造上、CPUやメモリを積んだミニコンピューターの様相となります。

- 各ポートから電気信号として対向からのデータを受信します
- 受信したデータを『一度デジタル信号(0と1)に復号化』します
- データをCPUで解析します
- データの先頭には『フレームヘッダ』という構造が含まれています
  - MACアドレスやプロトコルの情報が含まれています

イーサネットのレベル(データリンクのレベル)では、ひとかたまりのデータ構造を『フレーム』と称しています。

- フレームをひととおり取得して、イーサネットヘッダと呼ばれる構造を取得します
- イーサネットヘッダに含まれるMACアドレスを使って『このデータをどのMACアドレスに送るか』を決定します
- そのMACアドレスが繋がっている(と判定されている)ポートへデータを送出します

## どのポートに送ればいいのか?

イーサネットヘッダを調べる事で、送り先のMACアドレスを抽出し、送り先ポートを決定できるとしましたが、そもそもポートはどう決定しているのでしょうか

- スイッチには『メモリ』があるので、過去に受信したフレームの情報から『どのポートにどのMACアドレスがあるのか』を記憶できます、いわば辞書となるこのデータを用いて決めています
    - MACアドレステーブル
- 受信したフレームの『送信元』MACアドレスをポート番号と対にしてテーブルに記録することで、スイッチは次回以降のデータ転送を効率化します
- 無い場合はどうするのか
    - ブロードキャストフレームを生成して全ポートに送信する
    - ほとんど起きないが皆無ではない
- ブロードキャストフレーム
    - 宛先MACアドレスがFF:FF:FF:FF:FF:FF
    - すべてのMACアドレスに送信することを意味する
    - 必要とする所があれば、送信元MACアドレスに対して返信フレームを発行するだろう
        - ARPプロトコルがこれに該当する

## スイッチはどこまで処理するのか?

スイッチはその動作の性質上、CPUとメモリを持った小さなコンピューターという様相となっています。

- CPUの性能の及ぼす影響
    - 電気信号からの復号化、ビット列を電気信号に変換する速度に影響する
    - 処理が早ければメモリを空けるのも早くなる
- メモリの及ぼす影響
    - MACアドレスのテーブル容量(大きければ大きいほど記憶できる)
        - ただし一定時間ごとに不使用と判断されたレコードは破棄されていく
    - 未解析のフレームのバッファリングがしやすくなる
        - 処理待ちとして溜めておくことで、ちょっとした時間稼ぎとなる
        - 解析が遅かったりするとフレームが溢れることになる → その場合は破棄されるのと同じ

よって、高性能なものはCPUやメモリの性能・容量が高くなり、その分**価格に反映される**ことになります。
逆も然りです。

また、解析のタイミングというものも大きく2つ存在します。

- ストアアンドフォワード方式(Store and Forward)
    - 受信したフレームを一度メモリに格納してから、解析を行う
    - メモリに格納することで、フレームの整合性を確認できる
    - 整合性が確認できたら、ポートに転送する
    - 整合性が確認できなかった場合は、フレームを破棄する
    - 遅延が生じやすい(全てを読み込んで解析をする必要があるため)
- カットスルー方式(Cut Through)
    - 受信したフレームを全てメモリに入れる前にフレームヘッダ部分のみで解析を行ってしまう
    - 遅延が非常に小さいが、エラーがあってもそのまま転送する可能性

もともとは低遅延を求められるような環境ではカットスルー方式が使われていましたが、現状では性能の向上も相まって、信頼性確保の観点からストアアンドフォワード方式が一般的に使われています。
- 一例: [Buffaloのスイッチの仕様](https://arc.net/l/quote/ishchzbi)部分

## ちょっと変わったスイッチ達

個人向けのものではない企業(法人)向けのものだと、値段が当然上がりますが少し変わった(?)機能が付加されることがあります。

```{note}
もともと法人向けは壊れにくさや高可用性、性能面で個人向けよりもいいものを提供することが大半です。
そのため価格は当然個人向けより高いです。
ただし、企業内で使っているハブも管理を必要としないのであれば個人向けのものを使っていることが多いです。
```

### ポートミラーリング

![ポートミラーリングのイメージ](images/port-mirror.drawio.png)

- 特定のポートを出入りする信号を別ポートへ飛ばせる
- 監視用のポートを作成できる

もともとはバカハブ(区別のため敢えて呼称)が全ポート飛ばせていたので役立っていました。
しかしスイッチングハブの普及でバカハブが減ったため、監査の必要な場所ではこのような使い方をしているという感じです。

### VLAN(Virtual LAN)

![VLANのイメージ](image/vlan.drawio.png)

- 複数のLANを仮想的に分割できます
- ブロードキャストフレームの範囲を制限できます

例えば、同じハブに5台のホストがぶら下がっている状態とか呈した場合に、特定の3台と残り2台のホストを分けたい場合にVLANを利用できます。
- VLAN1
    - ホストA
    - ホストB
    - ホストC
- VLAN2
    - ホストD
    - ホストE

このように分けることで、ホストA,B,CはD,Eのブロードキャストフレームを受信しなくなります。

実装方式としては大きく2つが考えられます。

- ポート単位
    - 事前にポートごとにVLANを切り分ける方式
    - 例えば、ポート1,2,3をVLAN1、ポート4,5をVLAN2とする
- タグ付け方式
    - 受信したフレームにVLANの情報を付加して、ポートを分ける方式
    - 例えば、ポート1,2,3はVLAN1、ポート4,5はVLAN2とする
    - タグ付け方式は、IEEE802.1Qという規格に基づいています
    - タグ付け方式は、ポート単位よりも柔軟性がありますが、スイッチの性能に影響を与えることがあります

もちろんミックスも可能な場合があり、それぞれの機能を組み合わせることもあります。

例えば8ポートありますという場合に、以下のように設計したとします。

- ポート1-7はタグ付きVLANで設計
- ポート8は別VLANとなるポートに設定

こうすることで、ポート8はポート1-7のVLANに参加しないことになります。
その下にハブや無線APをぶら下げることで、ゲスト用に設定するといったことが可能になります。

```{note}
VLANの処理(特にタグ付きVLAN)は若干特別な処理をすることもあり、スイッチの性能に影響を及ぼす可能性があります。
そこで、そのスイッチにおいてデフォルトとも言えるVLANに対してはタグを付与せず通常のフレームを用いて、一部のVLANの信号のみタグを付けるという考え方もあります。
こういうのは『ネイティブVLAN』と呼ぶことがあります。
```

### L2 スイッチ

VLANなポートミラーリングなど、単なるスイッチングハブ(フレームを理解して転送できる程度)からさらに進んだ機能を持つものに関しては、**L2スイッチ**(レイヤー2スイッチ)と言われることがあります。といっても区別の上でそう呼ばれる程度ですが、ネットワークの敷設を検討する際や、製品カテゴリとして登場します。

