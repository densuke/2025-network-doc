# 迷惑メール(spam)対策

メールはそのシンプルな仕組みが故に、悪用されやすいプロトコルです。
たとえば`MAIL FROM`や`RCPT TO`コマンドで送信者や受信者を偽装することが容易にできてしまいます。
このため、スパムメール(迷惑メール)の送信にSMTPが悪用されることがあります。

そのため、スパムメールに対して様々な対策が後年講じられるようになりました。ここではそのいくつかを紹介します。

## SPF

SPFはSender Policy Frameworkの略で、送信ドメイン認証の一つです。
SPFは、送信元のIPアドレスが、そのドメインからメールを送信することを許可されているかどうかを検証します。
この仕組みは、DNSにSPFのためのレコード(`TXT`レコード)を追加することにより機能します。
例えば本学(kobedenshi.ac.jp)であれば、このような形で取得されます。

```
kobedenshi.ac.jp descriptive text "v=spf1 include:gmail.com include:aspmx.pardot.com +ip4:149.72.34.16 include:_spf.prtimes.jp ~all"
```

この情報を『受信しようとしているメールサーバー』は参照し、以下のようなルールのもとで送信元IPアドレスの検証を行います。
- `v=spf1` : SPFレコードのバージョン
- `include:ドメイン` : 指定したドメインのSPFレコードを参照
- `ip4:IPアドレス` : 指定したIPv4アドレスからの送信を許可
- `+` : 合格(Pass)
- `-` : 不合格(Fail)
- `~` : ソフトフェイル(SoftFail) ※ 警告扱い
- `?` : ニュートラル(Neutral) ※ 判定しない
- `all` : すべての送信元に対するルール

これにより、レコード上から探索された結果と接続元IPアドレスを比較して、正当な送信者と判定できればPassするという仕組みです。
ある程度の効果はありますが、SPFだけでは不十分な場合も多いため、他の対策と組み合わせて使用されることが一般的です。

## DKIM

DKIM(DomainKeys Identified Mail)は、電子メールの送信ドメイン認証の一つで、メールの改ざん防止と送信者の正当性を確認するための仕組みです。
DKIMは、送信者のドメインが所有する秘密鍵を使用してメールにデジタル署名を付与し、受信者側は対応する公開鍵を使用して署名を検証します。
この仕組みにより、以下の事が可能となります。

- メールの改ざんが(少なくともメールサーバーより後では)発生していないことを確認できる
- 送信者が正当なドメイン所有者であることを確認できる(ISP利用者であれば適切なSMTPサーバーからの送信でないとそのISPの署名がつかない)

受信したメールサーバーは、DNSからDKIM用の公開鍵を取得し、メールに付与された署名を検証します。
署名が有効であれば、メールが改ざんされていないことと送信者の正当性が確認されます。
DKIMはSPFと組み合わせて使用されることが多く、これによりスパムメールやフィッシングメールの検出精度が向上します。

## DMARC

DMARC(Domain-based Message Authentication, Reporting & Conformance)は、SPFおよびDKIMと連携して動作するメール認証プロトコルです。
DMARCは、送信ドメインの所有者が、受信側に対してメールの処理方法を指示するための仕組みを提供します。
これにより、なりすましメールやフィッシング攻撃を防止することができます。
DMARCは、DNSにDMARCポリシーレコードを追加することで機能します。
このレコードには、以下の情報が含まれます。
- ポリシー: 受信側がSPFおよびDKIMの検証に失敗した場合の処理方法(例: none, quarantine, reject)
- レポート: 認証結果のレポート送信先
- 整合性: 送信ドメインとFromヘッダのドメインが一致するかどうかの確認方法

## 機械学習など

メールに対する『学習』でスパムメールを検出するという試みは機械学習技術の発展の前から行われてきました。

- キーワードフィルタリング: 初期のMUAから搭載されていた、特定のキーワードでスパムを検出する方法
- ベイズ推定(ベイジアン)フィルタリング: メールの内容に基づいてスパム確率を計算し、一定の閾値を超えた場合にスパムと判定する方法
    - スパムと非スパム(ハム)のメールをそれぞれ学習させることで、特定もしくは類似するパターンに対するスコアを操作して高精度な判定を行う

特にベイズ推定はデータの量が多いほど精度が向上するため、大量のメールを扱うメールサーバーで効果を発揮します。
そのため、gmailやoutlook.comなどの大手メールサービスが、自社に届いた迷惑なメールをどんどん学習させることで非常に高精度な迷惑メールフィルタを実現しています。

現在大手のWebメールサービスはたいてい、SPF/DKIM/DMARCなどの認証技術と機械学習ベースのフィルタリングを組み合わせて、迷惑メール対策を行っています。
また、MUA側でもその情報を使ったフィルタリングを行ったり(OutlookのSmartScreen技術など)、ユーザーが手動で迷惑メールを指定して学習させる機能なども提供されています。
