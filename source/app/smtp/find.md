# メールサーバーの選定

メールは、宛先のメールサーバーに向けて転送されると説明しましたが、そのメールサーバー自体はどのように見つけているのでしょうか。

## DNSとの連携

メールサーバーは全世界のいたるところで稼働しており、常に増減していると考えられます。そのため新規にメールサーバーができることもあれば、古いメールサーバー及び組織(ドメイン)が消滅することも起こり得ます。これをどのように見つけられるようになっているのでしょうか。

この仕組みは、DNSと連携しています。
DNSでは、リソースレコードとして MX (Mail eXchanger) が用意されています。
これを用いて、特定のドメインに対してメールを受け取るメールサーバーがどこに存在するのかを問い合わせることができます。

メールサーバーはメールを受信すると、送り先をどのように判定するかをここで説明しましょう。

1. 送信先となるメールアドレスのドメインを SMTP のエンベロープ (RCPT TO) から取得します(ヘッダの To: と必ずしも一致しません)。ここでは `fugahoge@example.com` とします。
2. `example.com` ドメインに対してDNSのMXレコードを問い合わせます。
3. MXレコードの応答として、`mail.example.com` というホスト名が返ってきたとします。
4. `mail.example.com` の A レコード (もしくは AAAA レコード) を問い合わせて、その IP アドレスを取得します。
5. 取得したIPアドレスに対してSMTPで接続し、メールを送信します。

補足: MX レコードが存在しない場合、RFC 5321 の規定により当該ドメイン名の A/AAAA レコードへフォールバックして接続先を決定します(ただし、明示的に「メールを受け付けない」ことを示す Null MX を設定している場合は除きます)。

MXレコードを実際に取得してみましょう。環境別に紹介します。

```bash
# Linux/macOSの場合
% host -t mx st.kobedenshi.ac.jp
st.kobedenshi.ac.jp mail is handled by 10 aspmx.l.google.com.
```

```powershell
# Windows(PowerShell)の場合
PS> Resolve-DnsName -Type MX st.kobedenshi.ac.jp
Name                  Type   TTL   Section    NameExchange          Preference
----                  ----   ---   -------    ------------          ----------
st.kobedenshi.ac.jp   MX     300   Answer     aspmx.l.google.com    10
```

```console
# Windows(コマンドプロンプト)の場合
> nslookup -type=mx st.kobedenshi.ac.jp
サーバー:  dns.google
Address:  8.8.8.8

権限のない回答:
st.kobedenshi.ac.jp     MX preference = 10, mail exchanger = aspmx.l.google.com
```

これらのコマンドを実行すると、`st.kobedenshi.ac.jp` ドメインのメールサーバーが `aspmx.l.google.com` であることがわかります。

````{note}
これまで、例示としてexample.comというドメインを出してきました。
このドメインは実際に存在していますが、特定の組織に結びつけられているわけではない『予約』されたドメインです。
文書などでの明示、例示のために予約されたものであり、実際に運用において影響が殆ど出ないように設計されています。
実際 MX レコードを引いてみても、

```bash
$ host -t mx example.com
example.com mail is handled by 0 .
```

となっており、`mail is handled by 0 .` は RFC 7505 で定義された Null MX の表記です。これは「このドメインはメールを受け付けない」ことを明示する設定です。つまり、実際にはメールを受け取る相手は存在しません。
逆に文書化するときに、実在するドメインを記述すると、何らかの操作の影響で実際に迷惑がかかることがあるため、注意が必要です。

````

## 選定方法と優先度

メールの送り先をMXレコードで調べることがわかったとしても、複数のメールサーバーが登録されている場合はどうなるのでしょうか。
複数のメールサーバーを用意することで、メールのインフラに影響があったとしても予備が受信を代行してくれるようになり、安定性向上につながっていいのですが、あまりにランダムに選定されて困ります。
そのために、MXレコードにはPreference(優先度)という値が設定されています。この値が**小さいほど優先度が高く**なり、メールサーバーはこの値を見て送信先を決定します[^cost]。

[^cost]: 優先度(preference)となると、一般に大きい方が強いと感じてしまうことがあります。実際には小さい方が優先される計算であり、そういう意味では『**コスト**』と見たほうが適切かもしれません。「数字が小さい=コストが低い=優先される」と考えるとわかりやすいでしょう。

たとえば、以下のようなMXレコードが登録されているとします。

```text
example.com.    IN    MX    10    mail1.example.com.
example.com.    IN    MX    20    mail2.example.com.
example.com.    IN    MX    20    mail3.example.com.
example.com.    IN    MX    30    mail4.example.com.
```

この場合、以下のルールでサーバーの選定を行います。

1. 最も優先度の高い(数値が小さい)MXレコードを持つサーバーを選定します。この場合、`mail1.example.com` が選ばれます。
2. もし選定されたサーバーが利用できない場合、次に優先度の高いMXレコードを持つサーバーを選定します。この場合、`mail2.example.com` と `mail3.example.com` が同じ優先度であるため、どちらかがランダムに[^rand]選ばれます。
3. さらに利用できない場合、次に優先度の高いMXレコードを持つサーバーを選定します。この場合、`mail4.example.com` が選ばれます。

[^rand]: どう選ばれるのかはメールサーバーの実装に依存します。例えばDNSのクエリ結果の順番(同じ順番で来るとは限らないため)や、直近で使ったことが有るならそちらを除外したラウンドロビン的考え方、本当にランダムに選定するなど、様々考えられます。

もし、最後まで利用できるサーバーが見つからなかった場合はどうするのでしょうか?
この場合は保留となり、しばらく時間をおいてから再送という形で配送を再試行します。
