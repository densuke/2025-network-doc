# 電子メールについて

いわゆる電子メール(email)は、インターネット上でメッセージを送受信するための仕組みです。私たちが日常的に利用しているメールサービスは、この電子メールの仕組みを利用しています。
現在では『電子』とつけずに単純に『メール』と表現していることが多くなっています、それぐらい当たり前に使われる技術ですが、最近ではチャットツールによってコミュニケーションが取られることも増えてきています。

とはいえ、メールは依然として重要なコミュニケーション手段であり、ビジネスや個人のやり取りに広く利用されています。メールは、テキストメッセージだけでなく、画像やドキュメントなどの添付ファイルも送信できるため、情報の共有に便利な手段となっています。

ここでは、そのような状況の電子メールの仕組みについて解説していきます。

## 歴史的な背景

電子メールの原型は、1960年代にアメリカの大学や研究機関で開発されました。当初は、同じコンピュータシステム内でのメッセージ交換が主な目的でしたが、1970年代に入ると、ARPANET（インターネットの前身）を通じて異なるコンピュータ間でのメール送信が可能になりました。1971年にレイ・トムリンソンが開発した最初のメールシステムは、@記号を使用してユーザー名とホスト名を区切る形式を導入し、これが現在のメールアドレスの基本形となりました。

## メールアドレス

メールアドレスは、各組織で管理されるというルールになっています。そのため、管理団体が自身を示す文字列(ドメイン)を取得し、そのドメインを使ってメールアドレスを作製します。メールアドレスは一般に以下の構造で表されます。

```text
username@domain
```
より具体的な例としては、以下のようになります。

```text
fugahoge@example.com
```

## ドメイン(domain)

ドメインは、インターネット上における『所属』に近い表現となっています。
そしてドメインは、DNSにおける階層構造をそのまま利用しています。

- example.comをドメインとしてみた場合
  - com: 最上位ドメイン(TLD: Top Level Domain)
  - example: セカンドレベルドメイン(SLD: Second Level Domain)

- mail.example.comをドメインとしてみた場合
  - com: 最上位ドメイン(TLD: Top Level Domain)
  - example: セカンドレベルドメイン(SLD: Second Level Domain)
  - mail: サードレベルドメイン(3LD: Third Level Domain)

メールにおけるドメインは、アドレスとメールボックス、およびメールサーバーの管理団体としての意味も持ちます。そのドメインを収容できるメールサーバーを何らかの形で用意し、受け取ったメールを保存するメールボックス構造を保持します。
そしてそのメールを利用者が読み書きできるようにアクセス環境の準備も必要です（読み出しには POP3/IMAP などのプロトコルが用いられます）。

## ユーザー(username)

ユーザーは、各ドメインの中で任意に作ることができます。
例えば、`example.com`ドメインの中で`fugahoge`というユーザーを作ると、メールアドレスとして、`fugahoge@example.com`が利用可能となります。

```{note}
実際には、ユーザー名に使用できる文字や長さなどに制限があります。また、同じドメイン内で同じユーザー名を持つことはできません。
```

## サブドメイン(subdomain)

ドメインは階層構造を持つため、サブドメインを利用して組織内での分類を行うということも可能です。
例えば `example.com` ドメインを想定した場合に、以下のようなドメイン、サブドメインを考えることができます。

- `sales.example.com`: 営業部門のメールアドレス
- `support.example.com`: サポート部門のメールアドレス
- `info.example.com`: 一般的な問い合わせ用のメールアドレス
- `staff.example.com`: 社員向けのメールアドレス

これにより、組織内でのメールアドレスの管理や分類が容易になります。

なお、サブドメインにより分類されているため、それぞれで同じユーザー名を用いることが可能です(例: `fugahoge@sales.example.com` と `fugahoge@support.example.com` は別のユーザーとして扱われます)。

## SMTPとメールサーバー

SMTP(Simple Mail Transfer Protocol)は、電子メールの送信に使用されるプロトコルです。
少し風変わりなものですが、大きく2つの役割に分けて使用されます。

### メールの送信

これは私たちがメールを作成するときに、SMTP を使用して送信の依頼を行います。
いわば郵便局のポストのようなものですが、現実の郵便局のように『最寄り』が使えるわけではなく、通常は自分の組織が提供する送信サーバー(Submission/"MSA")に認証して送ります（一般に 587/TCP で STARTTLS、または 465/TCP で SMTPS）。

```{note}
SMTP には、役割に応じた呼び名があります。

- MUA: Mail User Agent（ユーザーが使うメーラー）
- MSA: Mail Submission Agent（ユーザーからの送信を受け付けるサーバー、587/TCP など）
- MTA: Mail Transfer Agent（サーバー間でメールを中継する、25/TCP）
- MDA: Mail Delivery Agent（最終的にメールボックスへ配送する）

また、宛先の決定など配送処理が参照するのは SMTP のエンベロープ（MAIL FROM/RCPT TO）であり、ヘッダの From:/To: と一致しない場合があります。
```

### メールの転送

郵便局としてのSMTPは、メール送信を依頼されて受信すると、そのメールを宛先に向けて転送します。
この際も、受取先となるSMTPサーバー(別の郵便局)に向けてSMTPで送信することになります。

### 本質としては同じです

SMTPは自分が送るために利用することと、他のメールサーバーへ転送する目的のそれぞれで使われていますが、どちらにしても『手元にあるメール』を他のサーバーに『転送する/送信する』という意味で本質的には同じです。

```{mermaid}
graph LR;
    A[ユーザーの
    メールクライアント] -->|SMTPで送信依頼| B[自分の
    SMTPサーバー]
    B -->|SMTPで転送| C[宛先の
    SMTPサーバー]
    C -->|メールボックスに保存| D[受取人の
    メールボックス]
```

## メールの受信

逆に受け取った側のSMTPサーバーはどうなるのでしょうか。
受け取ったメールには大きく2つの可能性(とエラー)があります。

### 自分が受取先である

※ ここでの「自分」はメールサーバーのことです

自分が受取先と判断された時は、そのメールを保存しておきます。
受取人となるユーザーごとの『メールボックス』に受信したメールを保存し、利用者のアクセスを待ちます。

### 他への転送が必要である

これは主にサブドメインを使用している場合に発生します。
たとえば `support.example.com` ドメインのSMTPサーバーが `example.com` であるようなケースで、一旦受信した後、内部に存在する `support.example.com` ドメインのSMTPサーバーに転送する必要がある場合です。
これは、たとえばDMZ(境界エリア)にあるSMTPサーバーが一旦代表として受け取って、その後内部ネットワーク上のメールサーバーに分配するような構造です。

```{mermaid}
graph LR;
    A[外部の
    SMTPサーバー] -->|SMTPで転送| B[代表の
    SMTPサーバー]
    B -->|SMTPで転送| C[内部の
    SMTPサーバー]
    C -->|メールボックスに保存| D[受取人の
    メールボックス]
```

### エラーとなるケース

自身にメールが届いたときに、受信(もしくは一旦受け取っての転送)対象ではないと判定された場合は、エラーを返します。
また、受信すべきであったとしても内部的な障害(ストレージ不足で保存できない、そのようなユーザーが存在しない)という場合もエラーとなります。
エラーは一時的なもの(しばらくすれば改善が期待できるもの)と恒久的なもの(ユーザーが存在しておらず、受け取っても対応できない)に大別され、SMTP 応答コードでは前者が 4xx、後者が 5xx で表現されます。

## メールは分散サーバーである

メールは、所属する組織ごとに用意される仕組みとなっています。
そのため、メールサーバーは組織の数だけ存在していると考えてかまいません。
ただし、一つのメールサーバーが複数の組織を代表して受け取ることも可能なため、『イコール』とは言えませんので注意してください。
例えば本学のメール(`@st.kobedenshi.ac.jp`)は、本学専用のサーバーが対応しているわけではなく、GoogleのGmailサービスが対応しています。
