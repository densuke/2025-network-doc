# 基礎知識として「内蔵クロック」

```{note}
この部分はNTPの理解を助けるためのものです。
```


NTP は、Network Time Protocol の略で、コンピューターシステムの時刻を正確に同期させるためのプロトコルです。NTP はインターネット上で広く使用されており、サーバーやクライアント間で時刻情報を交換し、システムクロックを調整します。

その前の話として、コンピューターには基本的に内蔵時計が存在しています。
しかし、これらの内蔵時計は時間の経過とともにずれてしまうことがあります。NTPは、これらのずれを補正し、正確な時刻を維持するために使用されます。

## 内蔵クロックについて

本来コンピューターには内蔵クロックが存在しています。基板上の各種装置の入出力を同期させるために使われ、信号が乱れるとエラーのもとになります。

ここで時計には2種類あります。

- RTC (Real-Time Clock): マザーボード上のハードウェア時計。ボタン電池等で時刻を保持します (電池が切れると初期化されがち)。
- システムクロック: OS が稼働中に保持・補正する時計。NTP などで継続的に同期されます。

この内蔵クロックは、マザーボード上の水晶 (クリスタル) 発振器で駆動されます。発振器は一定周波数で振動し、時間基準を提供します。

しかし、水晶発振器は温度変化や経年劣化の影響を受け、時間の経過とともにずれます。一般的な PC 向け発振器の安定度は概ね ±10〜50 ppm 程度で、1日あたり約 0.9〜4.3 秒のずれが目安です (条件や品質によってはこれより悪化する場合もあります)。このずれは分散システムやネットワークアプリケーションで問題となるため、NTP による補正が有効です。サーバーなどでは TCXO/OCXO など高安定な発振器を用いて安定度を高める場合もあります。

```{note}
TCXO/OCXO の補足

- TCXO (Temperature-Compensated Crystal Oscillator): 温度変化に応じて補償を行うことで安定度を高めた水晶発振器です。一般に ±0.5〜2 ppm 程度の安定度が期待できます。
- OCXO (Oven-Controlled Crystal Oscillator): 発振子を恒温槽で一定温度に保つ方式で、さらに高い安定度を実現します。一般に ±0.01〜0.1 ppm 程度の安定度が期待できます。

トレードオフとして、TCXO/OCXO はコストや消費電力が増加し、特に OCXO はウォームアップ時間が必要です。高安定な基準は NTP による補正量を小さく抑えるのに有効ですが、サブミリ秒級の厳密な同期が必要な用途では PTP や GNSS による規律化 (GNSS-disciplined oscillator) も検討されます。
```

## クロックの持つ時間について


クロックが保持する時刻情報 (年月日、時間) は、大きく2つのタイプがあります。

- ローカルタイム(Local Time)
    - システムが設置されている地域の標準時刻
    - 地域に依存した時間の情報となっています
    - もし海外旅行などで時差が生じた場合、現地の時間に修正する必要があります
        - コンピューターがGPSを保有する場合、自動的に補正されることがあります
- 協定世界時 (UTC: Coordinated Universal Time)
    - 歴史的には GMT (Greenwich Mean Time) と近似的に扱われることがありますが、現在は UTC が時刻系の基準として採用されています (基準経線は同じくグリニッジ).
- 補足: サマータイム
    - 地域によってはサマータイム (夏時間) があり、春と秋の特定のタイミングで 1 時間のズレが生じます。
    - アメリカでは概ね 3 月第 2 日曜〜11 月第 1 日曜がサマータイム期間です。
    - 日本はサマータイムを採用していません。

時差の影響についてはソフトウェア処理が必要です。
たとえば日本では JST (Japan Standard Time) が使われていますが、これは UTC より 9 時間進んでいます。表記は一般に「JST (UTC+9)」とします。

時差情報は OS ごとのデータベースで管理されます。Linux では多くのディストリビューションで tzdata パッケージが該当します。地域名/都市名で構成され、日本では `Asia/Tokyo` が該当します。このファイルを `/etc/localtime` にシンボリックリンクすることで、システム全体のタイムゾーンを設定します。

systemd ベースの Linux では、`timedatectl` コマンドでタイムゾーンの確認や設定を行えます。

```bash
$ timedatectl
               Local time: 火 2025-11-18 10:49:16 JST
           Universal time: 火 2025-11-18 01:49:16 UTC
                 RTC time: 火 2025-11-18 01:50:02
                Time zone: Asia/Tokyo (JST, +0900)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no                
```
上記の例では、ローカルタイムがJST(日本標準時)、ユニバーサルタイムがUTC(協定世界時)として表示されています。
また、基板上の保存されている時刻(RTC)は「localtimeではなくUTC」であることが示されています。

そして、タイムゾーンの設定は `/etc/localtime` へのリンクで決まります。`RTC in local TZ: no` は RTC を UTC で運用していることを示し、一般に推奨されます。

```bash
$ ls -l /etc/localtime
lrwxrwxrwx 1 root root 30  4月 14  2025 /etc/localtime -> /usr/share/zoneinfo/Asia/Tokyo
```

と、タイムゾーンは Asia/Tokyo に設定されていることがわかります。

タイムゾーンを検索・設定する例:

```bash
$ timedatectl list-timezones | grep Asia/Tokyo
Asia/Tokyo
$ sudo timedatectl set-timezone Asia/Tokyo
```

