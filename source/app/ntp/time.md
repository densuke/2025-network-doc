# 基礎知識として「内蔵クロック」

```{note}
この部分はNTPの理解を助けるためのものです。
```


NTPは、Netwoprk Time Protocolの略で、コンピュータシステムの時刻を正確に同期させるためのプロトコルです。NTPは、インターネット上で広く使用されており、サーバーやクライアント間で時刻情報を交換し、システムクロックを調整します。

その前の話として、コンピューターには基本的に内蔵時計が存在しています。
しかし、これらの内蔵時計は時間の経過とともにずれてしまうことがあります。NTPは、これらのずれを補正し、正確な時刻を維持するために使用されます。

## 内蔵クロックについて

本来コンピューターには内蔵クロックが存在しています。基板上の各種装置からの入出力で同期を取るためなどに使っており、この信号が極度に乱れてしまうとエラーのもとになってしまいます。
内蔵クロックは、電池などでバックアップされるか、バッテリーによるバックアップが行われています。
これらの電源がなくなった場合、時計が初期化されることもしばしばあります(夏休みや冬休みなどにパソコンを全く使っていないと、起動時に日付や時刻がリセットされてしまうことがあります)。

この内蔵クロックは、コンピューターのマザーボード上にあるクリスタル発振器によって動作しています。
クリスタル発振器は、一定の周波数で振動することで、時間を計測する役割を果たしています。

しかし、クリスタル発振器は温度変化や経年劣化などの影響を受けやすく、時間の経過とともにずれてしまうことがあります。
ひどくなると、1日に数秒から数分のずれが生じることもあります。
このずれは、特に分散システムやネットワークアプリケーションにおいて問題となります。

## クロックの持つ時間について


クロックが保持する時刻情報(年月日、時間)は、大きく2つのタイプがあります。

- ローカルタイム(Local Time)
    - システムが設置されている地域の標準時刻
    - 地域に依存した時間の情報となっています
    - もし海外旅行などで時差が生じた場合、現地の時間に修正する必要があります
        - コンピューターがGPSを保有する場合、自動的に補正されることがあります
- 協定世界時(UTC: Coordinated Universal Time)
    - 古いとGMT(Greenwich Mean Time;いわゆるグリニッジ平均時間)とも呼ばれていたものです
    - 現在では原子時計に基づくUTCに置換されましたが、時間の基準として同じ位置(グリニッジ子午線)が継続利用されています
- 補足: サマータイム
    - 地域によってはサマータイム(夏時間)を持っている地域があり、春と秋の特定のタイミングで1時間のズレが生じる仕組みとなっています
    - アメリカを例に取ると、3月の第2日曜日から11月の第1日曜日までがサマータイム期間となっており、この期間中は標準時より1時間進んだ時間が使用されます

時差の影響についてはソフトウェア処理が必要です。
たとえば日本ではJST(Japan Standard Time)が使われていますが、これはUTCより9時間進んでいます。
このことを、表記上JST+9(JSTであり、UTCより9時間進んでいる)と表現します。

時差情報はOSごとに管理されているデータベースが存在します。Linuxの場合、多くのディストリビューションにおいてtzdataパッケージがこれに該当します。
大雑把に地域名、都市名で構成されており、日本ではAsia/Tokyoが該当します。この構成を`/etc/localtime`にシンボリックリンクを張ることで、システム全体で利用されるタイムゾーン情報を設定します。

SystemdベースのLinuxにおいては、`timedatectl`コマンドでタイムゾーンの確認や設定を行うことができます。

```bash
$ timedatectl
               Local time: 火 2025-11-18 10:49:16 JST
           Universal time: 火 2025-11-18 01:49:16 UTC
                 RTC time: 火 2025-11-18 01:50:02
                Time zone: Asia/Tokyo (JST, +0900)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no                
```
上記の例では、ローカルタイムがJST(日本標準時)、ユニバーサルタイムがUTC(協定世界時)として表示されています。
また、基板上の保存されている時刻(RTC)は「localtimeではなくUTC」であることが示されています。

そして、タイムゾーンの設定は `/etc/localtime` のため、こちらの状態でタイムゾーンがはっきりします。

```bash
$ ls -l /etc/localtime
lrwxrwxrwx 1 root root 30  4月 14  2025 /etc/localtime -> /usr/share/zoneinfo/Asia/Tokyo
```

と、タイムゾーンはAsia/Tokyoに設定されていることがわかります。

