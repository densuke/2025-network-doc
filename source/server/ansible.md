# Ansible

このセクションでは、Ansibleを導入してのサーバー構築/管理について学習していきます。

## はじめに

まず、業務であれ個人的なものであれ、ネットワークの機能構築をしようと思えば、サーバーを一般的に使います。
問題はサーバーの構築という行為において、直接システムの持つ管理機構を叩くという行為を見直す必要があるということです。
なぜでしょうか?

### 手順書の問題

サーバーの構築のために、各種の操作やツールの利用が必要になることは間違いありません。
問題は、その手順は『再現性がありますか?』ということです。
例えば、あるサーバーを構築するために、10個の手順が必要だったとします。
その10個の手順を、1つ1つ人間が実行していくとします。
1回目はうまくいきました。
2回目は、3つ目の手順でミスをしました。
3回目は、7つ目の手順でミスをしました。
このように、人間が手順を実行する場合、ミスが発生しやすくなります。
また、手順書が古くなっている場合もあります。

なによりドキュメントを読みながら操作をする際、ダブルチェックを行ったとしても、ヒューマンエラーが発生する可能性があります。

### キッティングの問題

サーバーであれクライアントであれ、システムを構築する際に『同じ手順の繰り返し』がよく発生します。
例えば10台のサーバーを構築して並列化の準備をしないといけないとなると、10台分の同じ手順を繰り返し実行する必要があります。
また、クライアントで考えたとしても、100台のノートパソコンをセットアップするなどの必要が生じることがあります。
このような場合、同じ手順を繰り返し実行することになります。
この場合も、ヒューマンエラーが発生する可能性があります。

```{note}
Windowsの世界では、このような問題に対してよく使われるのが`Sysprep`です。
マスターとなるマシン上でセットアップを完了させ、そのマシンの固有値をリセットしてイメージ化するという行為です。
このイメージを使って複数台のマシンをセットアップすることができます。
しかし、この方法はイメージを作成するマシンの環境に依存するため、環境が変わると問題が発生する可能性があります。

システム管理部などの部門に配属されたり、IT系の労働派遣(かつての「特定派遣」)で働く場合、このようなキッティング作業を大量にこなすことになる場合があります。
```

## 自動化の必要性とAnsible

このような問題を解決する方法として、自動化による対応があります。
初期化処理を行ったばかりのような、まだまっさらな環境を用意し(この部分はVMのイメージングや、クラウドプロバイダが提供するVPSが該当します)、その上で必要なソフトウェアのインストールや設定を自動化することで、ヒューマンエラーを防止し、再現性のある環境構築を実現します。

このような自動化を実現するためのツールとして、Ansibleがあります。
Ansibleは、Pythonで書かれたオープンソースの構成管理ツールであり、エージェントレスで動作するため、管理対象のサーバーに特別なソフトウェアをインストールする必要がありません。最低条件は、大まかに以下の通りです。

- 対象にログインできること(SSHやWinRMなど)
- Pythonがインストールされていること(Windowsの場合はPowerShellが利用可能であること)
- (おまけ)管理権限が行使できること

```{note}
同様のツールとして、以下も有名どころだと思います。

- Puppet
- Chef
- SaltStack
- Terraform
- CloudFormation(AWS専用)
- ARMテンプレート(Azure専用)
- Google Cloud Deployment Manager(GCP専用)
これらのツールは、それぞれ特徴がありますが、Ansibleは比較的シンプルで学習コストが低いため、初心者にも扱いやすいです。
```

## はじめてのAnsible

Ansibleの環境はPythonで構築されているため、uvを使ってAnsible環境は簡単に構築できます。
uvの使える環境であれば、以下の操作でAnsible環境を構築できます。

```{note}
授業用リポジトリを使う場合、初期設定込みで準備が終わっています。
リポジトリを取得後`uv sync`で終わります。
```

```bash
$ uv init system-config
$ cd system-config
$ rm main.py # このファイルは不要
$ uv add --dev ansible
```

## とりあえず使ってみる

Ansibleの基本的な動きを見るために、ファイルを少し用意しましょう。

```{literalinclude} src/hosts.yml
:language: yaml
:caption: hosts.yml
```

```{literalinclude} src/ansible.cfg
:language: text
:caption: ansible.cfg
```

作成後、ターミナル上で、以下のコマンドを実行してください。

```{code-block} bash
$ uv run ansible -i hosts.yml -m ping all
localhost | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
```

この操作は、いわゆる『導通』の確認です。対象となるホスト(ここではlocalhost)に対して、pingモジュールを実行し、応答があるかどうかを確認しています。
重要なのはその出力です。

- `SUCCESS`と表示されていること: 操作が成功したことを示しています。
- `"ping": "pong"`と表示されていること: pingモジュールが正しく動作していることを示しています。
- `"changed": false`: この操作ではシステムの状態が変更されなかったことを示しています。

最後の`changed: false`は非常に重要な概念です。
Ansibleの目的は、システムの構成を確認し、必要に応じて変更を加えていきます。
しかし、すでに同様の操作が完了している場合に繰り返し同じことをする必要はありません。
そのため、Ansibleは各操作がシステムの状態を変更したかどうかを追跡します。

これは『冪等(べきとう)性』と呼ばれる概念です。冪等性とは、同じ操作を何度繰り返しても結果が変わらない性質を指します。
Ansibleは、冪等性を保つことで、システムの状態を一貫して管理し、不要な変更を避けることができます。
このように、Ansibleはシステムの構成管理を効率的に行うための強力なツールです。