# 実践: Apache httpdサーバーを導入してみよう

以前の資料にて、実際にWebサーバーを導入する例としてApache HTTP Serverを取り上げました。
ここで改めて、Ansibleを用いた『冪等性』を意識した導入と設定を見てみましょう。

## Apacheの導入

Apache自体は、OSのパッケージ管理システム(Ubuntuのためapt)を用いたインストールとなります。
これ自体は、前回までの演習で触っているのでさほど難しいということはありません。

```{code-block}
:language: yaml

# Apache httpdのインストールと起動
    - name: Apache httpdのインストール
      apt:
        name: apache2
        state: present
```

ただし、ここまでの演習において、パッケージ導入がうまくいかない(リポジトリ情報がうまく取得できない)というケースが散見されていたので、おまじない代わりに事前に強制的にリポジトリを更新するようにしてみたいと思います。

タスク指定の冒頭で行っておくと良いでしょう。

```{code-block} 
:language: yaml

  tasks:
    - name: 最新のパッケージリストの更新
      apt:
        update_cache: yes
```

ここで前回までの内容から不要なものを削除して、`tasks`以下をスッキリさせてみましょう。

```{code-block}
:language: yaml

  tasks:
    - name: 最新のパッケージリストの更新
      apt:
        update_cache: yes
# Apache httpdのインストールと起動
    - name: Apache httpdのインストール
      apt:
        name: apache2
        state: present
```

この記述により、apache2パッケージの状態が確認され、入っていないようだったら追加処理が行われます。

## Systemdサービスの確認

サーバーは、インストールしただけでは動作しないことがあります。
一般にサーバー上のプロセス(サービス)は、OSの起動時に必要に応じて起動することになります。
そして、先程インストールされたとしたら、そもそも現在起動しているかも怪しいです。
そのため、サービスの状態として、以下の2点を考慮しておく必要があります。

- 現時点でサービスが起動しているか。
- OS起動時に自動的にサービスが起動するようになっているか。

この2点をチェックするために、Ansibleではserviceというモジュールがあります。
serviceモジュールを使って起動状態の確認と自動起動の確認をしておきましょう。

```{code-block}
    - name: Apache httpdサービスの起動と有効化
      service:
        name: apache2
        state: started
        enabled: yes
```

- state: サービスの現在の状態(あるべき姿)を指定します。
    - started: サービスが起動していることを保証します。停止している場合は起動します。
    - stopped: サービスが停止していることを保証します。起動している場合は停止します。
    - restarted: サービスを再起動します。
    - reloaded: サービスの設定を再読み込みします(サービス自体を止めない)[^reload]。
- enabled: サービスの自動起動設定を指定します。
    - yes: OS起動時に自動的にサービスが起動するように設定します。
    - no: OS起動時にサービスが自動的に起動しないように設定します。

[^reload]: すべてのサービスが再読み込みをサポートしているわけではありません。サービスが対応していない場合、Ansibleはエラーを返します。

これでApache HTTP Serverがインストールされ、起動していることが保証されました。