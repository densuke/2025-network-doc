# Ansibleの設定について

Ansibleを使う上で、いくつか設定が必要になります。
前の節では特に何も言わずに作製してもらいましたが、ここでちょっと説明を加えておきます。

## インベントリー(inventory)

Ansibleでは、管理対象のサーバー群をインベントリー(inventory)と呼びます。
インベントリーは、通常テキストファイルで記述され、管理対象のホスト名やIPアドレス、グループ分けなどを定義します。

```{literalinclude} src/hosts.yml
:language: yaml
:caption: hosts.yml
```

上記の例では、管理対象としてlocalhostを定義した状態になっています。
通常はリモートホストに対して接続するため、sshを用いた接続が大半ですが、localhostの場合は、接続方式(`ansible_connection`)に`local`を指定することで、ローカルマシン上での直接実行と解釈されます。

実際には、サーバーの用途(Webサーバー群やデータベースのサーバー群など)に応じたグループを子要素(children)として定義して、管理することが多いです。

## Ansibleの設定ファイル(ansible.cfg)
Ansible自体の動作の設定を行うためのファイルです。
以下は、基本的な設定例です。

```{literalinclude} src/ansible.cfg
:language: text
:caption: ansible.cfg
```

ここでは、Ansibleが認識するインタプリタ(python)のパスを指定しています。
接続先で要求するPythonインタプリタは通常`python`コマンドですが、UbuntuやDebian等では`python3`が使われます。この違いによる警告を避けるため、明示的に`python3`を指定しています。

以上が、Ansibleの基本的な設定内容です。

## Facts

Ansibleでは、管理対象となるホストに接続すると、標準でFactsと呼ばれる情報を取得します。Factsは対象ホストのOSやシステム情報といったものです。これらの情報に基づき、OSや環境に見合った動作へモードを切り替えるようになっています。
何らかの理由でFactsが不要という場合は、`gather_facts: no`のように指定することで、Factsの収集を無効化できます。

## Ansibleの呼び出し方法

Ansibleは、インベントリに対し、『モジュール』と呼ばれる作業単位を呼び出すという考え方で動きます。

実際の呼び出し例では、`-m ping`で呼び出していました。

```{code-block} bash
$ uv run ansible -i hosts.yml -m ping all
```

この例では、`ping`モジュールを使って、インベントリ内の全ホスト(`all`)に対してping操作を行っています。
pingモジュールは、対象ホストに対して接続が可能かということを確認するという機能を提供します。これ自体がシステムを改変することはないため、`changed: false`となっています。

例えば、パッケージを導入するモジュールである`apt`を使って、`htop`パッケージをインストールしてみましょう。

```{code-block} bash
$ uv run ansible -i hosts.yml -m apt -a 'name=htop state=present' -b  -K all
```

実行時にパスワードが聞かれます、エコーバックされませんが、いつものように`penguin`を入れておきましょう。しばらくすると完了します。

- `-i hosts.yml`: インベントリファイル
- '-m apt': aptモジュールを使用
- `-a 'name=htop state=present'`: モジュールに対する引数
  - `name=htop`: インストールするパッケージ名
  - `state=present`: パッケージをインストールする
    - 正確には「存在する状態」
- `-b`: sudo権限で実行(become)
- `-K`: sudoパスワードの入力を促す
- `all`: インベントリ内の全ホストに対して実行

重要なのは、**stateに対する値が"present"であること**です。これは「htopパッケージが存在する状態にする」という意味になります。
そのため、すでに『存在する』状態であれば、構成を変更する必要がないと判定します。
必ずインストールを行うわけではなく、状態を必ずチェックしてから必要に応じてインストールを行う、という動作になります。

なお『存在しない状態』はabsentとなるため、アンインストールを行うためには、`state=absent`と指定します。

```{note}
実際に自分でやってみましょう。
```

```{tip}
ちなみに`htop`は、Linux上でよく使われている『ちょっと高性能なtopコマンド』です。topコマンドはシステムの稼働状況を監視するためのコマンドですが、htopはより見やすく、操作性も向上しています。プロセスの一覧表示やCPU/メモリ使用率のグラフ表示などが特徴です。

より過激な表示にしたい場合、`btop`というものが存在しますが、おそらく今回の授業環境では標準で用意されていないのでインストールできないと思います。
```