# ルーティング(経路制御)

ルーティングは、ネットワーク上のパケットが、目的地となるアドレスへ適切に転送されるように経路を決定していくプロセスです。
データリンク(レイヤー2)では『同一のネットワーク』の中しか送受信できませんでしたが、この機能により『異なるネットワーク』間でもパケットを転送できるようになります。

## IPアドレスと経路制御について

IPアドレスとネットマスクを組み合わせることで、属しているネットワークを特定できます。
そのため、以下の考え方が各ホスト(ノードで)とることができます。

- 自分のネットワークに属しているホストへの転送
    - データリンク層(イーサネット)の仕組みを使ってMACアドレスレベルで直接届けることができます
- 自分のネットワークに**属していない**ホストへの転送
    - IP層でのルーティングを行い、目的のネットワークにパケットを転送します
    - このためには、経路制御表(ルーティングテーブル)を参照し、送り先(転送先)を決める必要があります

## 経路制御表(ルーティングテーブル)

経路制御表(ルーティングテーブル; routing-table)は、IP層でのルーティングを行うために必要な情報を保持しているデータベースです。
このテーブル(データベース)は、各ホスト(ノード)上に存在しています。
起動時にカーネル上のメモリ上に構築されます。

- 起動時にネットワークを構成したときにルーティングテーブルに追加されます
- 静的エントリー(ファイル)がある場合は、適当なタイミングでルーティングテーブルに追加されます
- DHCP(動的構成)の場合、ネットワークから切り離された時点で該当するエントリーが削除されます

ルーティングテーブルの確認方法は、各OSで様々です。

### Windowsの場合

```powershell
# Windows PowerShell
PS> Get-NetRoute
```

![Windows PowerShellでのルーティングテーブルの確認](images/routing-table-windows.png)

以下は、`Get-NetRoute` コマンドで表示される主なフィールドの説明です。

- **InterfaceIndex** (ifIndex)
    この経路が関連付けられているネットワークインターフェースのインデックス番号
- **DestinationPrefix**  
    宛先ネットワークアドレスとプレフィックス長（例: 192.168.1.0/24）
- **NextHop**  
    パケットを転送する次のルーター（ゲートウェイ）のIPアドレス
- **RouteMetric**  
    経路の優先度を示す値（数値が小さいほど優先される）
- **IntefaceMetric** (ifMetric)  
    ネットワークインターフェースの優先度を示す値（数値が小さいほど優先される）
- **PolicyStore**  
    経路情報が保存されている場所

これらのフィールドを確認することで、どのネットワーク宛てのパケットがどの経路を通るかを把握できます。

大雑把には、以下の方法でパケットの送信先を決定しています。

1. ルーティングテーブルを確認し、宛先IPアドレスに一致するエントリーを探します
    - DestinationPrefixを参照します
    - 書かれているIPアドレスとネットマスクが、送ろうとしているパケットの宛先IPアドレスを含むか確認します
        - 宛先IPアドレスとネットマスクの積を取って確認する
2. 一致するエントリーが見つかった場合、そのエントリーに基づいてパケットを転送します
    - 複数該当した場合は、RouteMetricの値が最小のものをみつけ、その上でifMetricの値が最小のものを選択します
3. 一致するエントリーが見つからなかった場合、デフォルトルート(デフォルトゲートウェイ)を使用します
    - デフォルトルートは、通常、`0.0.0.0/0`となるため、他にマッチしていなければ全てのアドレスがマッチします(あらゆるIPアドレスにネットマスク0(=0.0.0.0)を適用すれば確実に0.0.0.0になる)
    - デフォルトルートが採択された場合、NextHopに指定されたIPアドレスにパケットを転送します

こうして利用すべきレコードをルーティングテーブル上で見つければ、ifIndexを参照して該当するインターフェースに対して **データリンク層を使って** 送信します。
最終的な送り先は、直接的に送信できる範囲であればMACアドレスを使ったデータリンクのレベルでの転送が行われるからです。
デフォルトルートが採択された場合、直接相手のアドレスに送れないため、指定されたアドレス(=NextHopのアドレス)はいわば「中継地点」として扱われます。
この中継地点は、ルーターやゲートウェイと呼ばれるものとなります。

以下に各OSごとのルーティングテーブルの取得方法を示しますが、必要なのは以下のことです。

- 宛先IPアドレスが自分のネットワークの内か外か
- 宛先が決定した後は対象となるホストへのインターフェースを決定できるか


### Linuxの場合

現代のLinuxでは`ip`コマンドを用いて表示させます。

```bash
$ ip route
```

![Linuxでのルーティングテーブルの確認](images/routing-table-linux-ip.png)

こちらは比較的シンプルな表示になっています。

- `default via` はデフォルトルートを示しています
- `dev` はインターフェース名を示しています

かなり省略されている感じです。そういう意味では旧来の`route`のほうがもう少し詳細に出力されます。

```{note}
`ifconfig`コマンドのために`net-tools`を入れていれば、`/sbin/route`コマンドが使えるようになっています。
```

### macOSの場合

```zsh
% netstat -rn
```

![macOSでのルーティングテーブルの確認](images/routing-table-macOS.png)

ARP[^arp]で取得したと思われるIPとMACアドレスの対応関係も含まれるため、出力数がすごく多いです。

[^arp]: Address Resolution Protocol、IPアドレスからMACアドレスを調べるためのプロトコルです(後ででる予定)。

## ルーター(ゲートウェイ)

ルーター(router)もしくはゲートウェイ(gateway)は、異なるネットワーク間でパケットを転送するためのデバイスです。
ルーターは、IP層でのルーティングを行い、パケットを目的のネットワークに転送します。

前述の『デフォルトルート(デフォルトゲートウェイ)』は、このルーターを指すことになります。
ルーターはいわばネットワークの『境界線』にあたるもので、隣接するネットワークごとの回線を持つ存在です。

![ルーターのイメージ](images/router.drawio.png)

- ルーターは自身の各インターフェースごとに接続しているネットワークの情報を持っています
- ルーターは、各インターフェースからパケットを受信し、宛先IPアドレスに基づいて適切なインターフェースにパケットを転送します

もしネットワーク上に複数のルーターが存在する場合も、それぞれのインターフェースが同じネットワークに存在しているはずなので、ルーターは別のネットワークへ転送する必要があるなら最適と思われるルーターを選択してパケットを転送することになります。

## ルーティングプロトコル

ルーターは別のネットワークへの転送経路を決定するために、隣接するルーターの情報を用いる必要がでることもあります。
このため、ルーター同士が情報を交換するために『ルーティングプロトコル』を用いて対応していることがあります。

状況や規模に応じたプロトコルが存在します。
代表的なものをあげると、以下のようなものが知られています。

- RIP(Routing Information Protocol)
    - 簡単なプロトコルで、主に小規模なネットワークで使用されます
    - ホップ数を基準に経路を選択します
    - 現在はRIP2が主流です
- OSPF(Open Shortest Path First)
    - 大規模なネットワークで使用されるプロトコルです
    - リンク状態ルーティングプロトコルで、各ルーターがネットワークの状態を把握し、最適な経路を計算します
- BGP(Border Gateway Protocol)
    - インターネットのルーティングに使用されるプロトコルです
    - 自律システム間での経路情報を交換するために使用されます
    - 大規模なネットワークやISP間でのルーティングに適しています

```{note}
RIPについては、過去に基本情報で(RIPと書かずに)出していたことがあります。

→ [H.23特別試験 午後 問4](https://www.fe-siken.com/kakomon/23_toku/pm04.html)
```

またルーター上のルーティングテーブルは、情報交換により値が蓄積すると、ルーティングテーブルのエントリーが増えていきます。
増えすぎると、ルーティングの性能が悪化するため、可能であればルーティングテーブルのエントリーを『集約』することで性能を改善されることもあります。

## パケットの分割処理

ルーティングの際、パケットが分割されることがあります。
例えばイーサネット(データリンク)に送るとき、通常フレームのペイロード長は1500バイトまでとなっています[^jumbo]。
そのため、IPパケットが1500バイトを超えてしまうときは、分割して送信する必要があります。

分割の基準となるのは各レイヤーにおけるパケット(フレーム)の大きさであり、これをMTU(Maximum Transmission Unit)と呼びます。
MTUは、各レイヤーにより異なっています。
主な層とプロトコルで簡単な表にすると、以下の通りです。

| プロトコル | MTU (バイト) |
|:----------:|:------------:|
| Ethernet   | 1500         |
| IPv4       | 65535        |
| IPv6       | 65535        |
| TCP        | 65535        |
| UDP        | 65507        |
| ICMP       | 65507        |

このため、イーサーネットを通過しようとする際に、上位層でより大きなサイズで入ってくると、データリンクに落とし込むときに分割が発生してしまいます。
この処理はデータリンク層において負荷がかかる可能性があるため、なんなら最初から上位層で分割しておくことで負荷を下げることが期待されます。

実際、`tcpdump`などでパケットキャプチャすると、各フレームのサイズは1500より下回っていることが多いです。
以下の図は、Ubuntu Linuxのイメージ配布サイトからダウンロードをしている最中(約3GB)に、`tcpdump`でキャプチャした時の様子ですが、ここでは1402オクテットずつ落ちてきています(1500でないことは、ここでは気にしないでください)。

![tcpdumpでのパケットキャプチャ](images/fragment.png)


[^jumbo]: ジャンボフレームと呼ばれる拡張により、より大きなペイロードを保有できることがありますが、それは事前にスイッチ間で決めておく必要があります。