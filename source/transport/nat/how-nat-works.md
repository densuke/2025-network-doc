# NATの動作原理

NATは、主に送信元IPアドレスと宛先IPアドレスの変換を行います。これにより、内部ネットワークのデバイスが外部と通信したり、外部から内部の特定のデバイスにアクセスしたりすることが可能になります。

## NATテーブル

NATデバイスは、IPアドレスとポート番号の変換情報を『NATテーブル』または『NATエントリ』として保持します。このテーブルは、内部から外部への通信(送信元NAT)の場合に動的に作成され、外部からの応答パケットを正しい内部デバイスに転送するために使用されます。宛先NAT(スタティックNATやポートフォワーディング)の場合、変換ルールは事前に設定され、常にテーブルに存在します。

### NATテーブルの例 (NAPTの場合)

| プロトコル | 内部IPアドレス | 内部ポート | 外部IPアドレス | 外部ポート | TTL |
| :--------: | :------------: | :--------: | :------------: | :--------: | :-: |
|    TCP     |  192.168.1.10  |   10000    |  203.0.113.1   |   50000    | 300 |
|    TCP     |  192.168.1.11  |   20000    |  203.0.113.1   |   50001    | 300 |

このテーブルにより、NATデバイスは、外部からの応答パケット(例: 宛先が203.0.113.1:50000)を受信した際に、それを内部の192.168.1.10:10000へ正しく転送できます。

### TTL (Time To Live) の役割

NATテーブルのエントリには、通常『TTL (Time To Live)』という有効期限が設定されています。これは、そのNATエントリがどれくらいの期間、NATデバイス内に保持されるかを示す値です。TTLは、通信が一定時間行われない場合に、不要なエントリを自動的に削除し、NATテーブルのサイズを適切に保つために利用されます。

TTLが設定されていることで、以下のようなメリットがあります。

*   **リソースの解放**: 通信が終了したエントリを自動的に削除することで、NATデバイスのメモリやCPUリソースを効率的に利用できます。
*   **セキュリティの向上**: 不要なエントリが残存することを防ぎ、セキュリティリスクを低減します。
*   **IPアドレス/ポートの再利用**: 動的に割り当てられるグローバルIPアドレスやポート番号を、他の通信で再利用できるようになります。

TTLの値は、プロトコルや通信の種類によって異なり、ルーターやファイアウォールの設定で調整可能です。例えば、TCPの通信では比較的長いTTLが設定されることが多く、UDPの通信では短いTTLが設定されることがあります。

```{note}
TTLの300秒については、明確にRFCで定義されたものではなかったりします。
[RFC 4787](https://tools.ietf.org/html/rfc4787)において、NATの動作に関するガイドラインが提供されていますが、具体的なTTLの値は実装や環境によって異なることがあります。せいぜい『UDPに対しては2分未満にするべきではない』という程度のようです。

実際の運用からに基づく『経験則』と思われます。
```

## 送信元NAT (Source NAT)

送信元NATは、内部ネットワークから外部ネットワークへ通信する際に、送信元IPアドレスを変換する方式です。これは、プライベートIPアドレスを持つデバイスがインターネットにアクセスする際に最も一般的に使用されます。NAPTも送信元NATの一種です。

### 動作フロー

1.  **内部から外部への通信開始**: 内部ネットワークのデバイス(例: 192.168.1.10)が、外部のサーバー(例: 203.0.113.100)へ通信を開始します。
2.  **NATデバイスでの変換**: パケットがNATデバイスに到達すると、NATデバイスはパケットの送信元IPアドレス(192.168.1.10)を、自身の持つグローバルIPアドレス(例: 203.0.113.1)に変換します。NAPTの場合、送信元ポート番号も変換されます。

    変換前後の比較:

    | 項目         | 変換前 (内部からNATデバイスへ) | 変換後 (NATデバイスから外部へ) |
    | :----------- | :----------------------------- | :----------------------------- |
    | 送信元IP     | 192.168.1.10                   | 203.0.113.1                    |
    | 送信元ポート | 10000                          | 50000 (例)                     |
    | 宛先IP       | 203.0.113.100                  | 203.0.113.100                  |
    | 宛先ポート   | 80                             | 80                             |

3.  **NATテーブルへの登録**: NATデバイスは、変換前の情報(内部IPアドレス、内部ポート)と変換後の情報(NATデバイスのグローバルIPアドレス、変換後のポート)を対応付けてNATテーブルにエントリとして追加します。この際、既に同じ変換情報がNATテーブルに存在し、かつTTLが有効な場合は、既存のエントリが更新されることもあります。新規の通信であれば、新しいレコードが追加されます。これにより、外部からの応答パケットを正しく内部のデバイスに転送するための情報が保持されます。

    NATテーブルへの追加例:

    | プロトコル | 内部IPアドレス | 内部ポート | 外部IPアドレス | 外部ポート | TTL |
    | :--------: | :------------: | :--------: | :------------: | :--------: | :-: |
    |    TCP     |  192.168.1.10  |   10000    |  203.0.113.1   |   50000    | 300 |

4.  **外部への送信**: 変換されたパケットが外部ネットワークへ送信されます。
5.  **外部からの応答**: 外部サーバーからの応答パケットがNATデバイスに到達します。このパケットの宛先IPアドレスは、NATデバイスのグローバルIPアドレスです。
6.  **NATデバイスでの逆変換**: NATデバイスは、受信した応答パケットの宛先IPアドレスとポート番号を基にNATテーブルを参照します。NATテーブルに登録されているエントリと一致するものを探し、そのエントリに紐づく元の内部IPアドレスとポート番号に逆変換します。

    逆変換前後の比較:

    | 項目         | 変換前 (外部からNATデバイスへ) | 変換後 (NATデバイスから内部へ) |
    | :----------- | :----------------------------- | :----------------------------- |
    | 送信元IP     | 203.0.113.100                  | 203.0.113.100                  |
    | 送信元ポート | 80                             | 80                             |
    | 宛先IP       | 203.0.113.1                    | 192.168.1.10                   |
    | 宛先ポート   | 50000 (例)                     | 10000                          |

7.  **内部への転送**: 逆変換されたパケットが、内部ネットワークの元のデバイスに転送されます。

```{mermaid}
graph TD
    subgraph 内部ネットワーク
        A["クライアント (192.168.1.10:10000)"]
    end
    B["NATデバイス (203.0.113.1)"]
    subgraph 外部ネットワーク
        C["Webサーバー (203.0.113.100:80)"]
    end

    A -- "リクエスト (Src:192.168.1.10:10000, Dst:203.0.113.100:80)" --> B
    B -- "変換 (Src:203.0.113.1:50000, Dst:203.0.113.100:80)" --> C
    C -- "応答 (Src:203.0.113.100:80, Dst:203.0.113.1:50000)" --> B
    B -- "逆変換 (Src:203.0.113.100:80, Dst:192.168.1.10:10000)" --> A

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#cfc,stroke:#333,stroke-width:2px
```

## 宛先NAT (Destination NAT)

宛先NATは、外部ネットワークから内部ネットワークへ通信する際に、宛先IPアドレスを変換する方式です。これは、外部に公開したい内部サーバー(Webサーバーなど)がある場合に利用されます。ポートフォワーディングも宛先NATの一種です。

### 動作フロー

宛先NATでは、事前にNATテーブルに変換ルールが設定されています。例えば、以下のようなルールが設定されているとします。

| プロトコル | 外部IPアドレス | 外部ポート | 内部IPアドレス | 内部ポート | TTL |
| :--------: | :------------: | :--------: | :------------: | :--------: | :-: |
|    TCP     |  203.0.113.1   |     80     |  192.168.1.10  |     80     |  *  |

1.  **外部から内部への通信開始**: 外部のクライアント(例: 203.0.113.200 送信元ポート40000)が、NATデバイスのグローバルIPアドレス(例: 203.0.113.1)の特定のポート(例: 80番ポート)へ通信を開始します。
2.  **NATデバイスでの変換**: NATデバイスは、受信したパケットの宛先IPアドレス(203.0.113.1)とポート番号(80)を、事前に設定されたNATテーブルを参照して、内部サーバーのプライベートIPアドレス(例: 192.168.1.10)とポート番号(80)に変換します。

    変換前後の比較:

    | 項目         | 変換前 (外部からNATデバイスへ) | 変換後 (NATデバイスから内部へ) |
    | :----------- | :----------------------------- | :----------------------------- |
    | 送信元IP     | 203.0.113.200                  | 203.0.113.200                  |
    | 送信元ポート | 40000                          | 40000                          |
    | 宛先IP       | 203.0.113.1                    | 192.168.1.10                   |
    | 宛先ポート   | 80                             | 80                             |

3.  **NATテーブルへの登録**: この静的な変換ルールに基づき、通信が発生すると、NATデバイスは戻りの通信を処理するために動的なセッション情報をNATテーブルに登録します。


4.  **内部への転送**: 変換されたパケットが、内部ネットワークのサーバーに転送されます。
5.  **内部サーバーからの応答**: 内部サーバーからの応答パケットがNATデバイスに到達します。このパケットの送信元IPアドレスは、内部サーバーのプライベートIPアドレスです。
6.  **NATデバイスでの逆変換**: NATデバイスは、受信した応答パケットの送信元IPアドレスを、NATデバイスのグローバルIPアドレスに逆変換します。もちろんこの時はNATテーブルを参照します。

    逆変換前後の比較:

    | 項目         | 変換前 (内部からNATデバイスへ) | 変換後 (NATデバイスから外部へ) |
    | :----------- | :----------------------------- | :----------------------------- |
    | 送信元IP     | 192.168.1.10                   | 203.0.113.1                    |
    | 送信元ポート | 80                             | 80                             |
    | 宛先IP       | 203.0.113.200                  | 203.0.113.200                  |
    | 宛先ポート   | 40000                          | 40000                          |

7.  **外部への転送**: 逆変換されたパケットが、外部ネットワークのクライアントに転送されます。

```{mermaid}
graph TD
    subgraph 外部ネットワーク
        A["クライアント (203.0.113.200)"]
    end
    B["NATデバイス (203.0.113.1)"]
    subgraph 内部ネットワーク
        C["Webサーバー (192.168.1.10:80)"]
    end

    A -- "リクエスト (Src:203.0.113.200, Dst:203.0.113.1:80)" --> B
    B -- "変換 (Src:203.0.113.200, Dst:192.168.1.10:80)" --> C
    C -- "応答 (Src:192.168.1.10:80, Dst:203.0.113.200)" --> B
    B -- "逆変換 (Src:203.0.113.1:80, Dst:203.0.113.200)" --> A

    style A fill:#cfc,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#f9f,stroke:#333,stroke-width:2px
```
