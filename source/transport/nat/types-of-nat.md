# NATの種類

NATにはいくつかの種類があり、それぞれ異なる方法でIPアドレスの変換を行います。主なNATの種類は以下の通りです。

## スタティックNAT (Static NAT)

スタティックNATは、プライベートIPアドレスとグローバルIPアドレスを1対1で静的に関連付ける方式です。特定のプライベートIPアドレスを持つデバイスに対して、常に同じグローバルIPアドレスが割り当てられます。主に、内部ネットワークにあるサーバー(Webサーバーやメールサーバーなど)を外部に公開する場合に利用されます。


```{note}
完全に余談です、一般的な話としてNATと出ると、後述のNAPT(IP Masquerade)を指すことが大半です。
そのため、NAPTのことをさすNATと区別するために『スタティックNAT』と表記・呼称することがあります。

ただ、正直スタティックNATは現状では用途的にあまり使われておりません。
筆者(佐藤)は、こちらが本来のNATだったということで勝手に『純NAT』と呼ぶことがあります。
あくまで勝手にです。他では通じないことでしょう。
```

### 特徴

*   **1対1の変換**: 1つのプライベートIPアドレスに対して、1つのグローバルIPアドレスが固定で割り当てられます。
*   **外部からのアクセス**: 外部からグローバルIPアドレスを指定することで、内部のサーバーに直接アクセスできます。
*   **IPアドレスの節約効果は低い**: グローバルIPアドレスの節約にはあまり貢献しません。

```{mermaid}
graph TD
    subgraph プライベートネットワーク
        A["内部サーバー (192.168.1.10)"]
    end
    B[NATデバイス]
    C[インターネット]

    A -- リクエスト --> B
    B -- Translate (192.168.1.10 -> 203.0.113.10) --> C
    C -- 応答 --> B
    B -- Translate (203.0.113.10 -> 192.168.1.10) --> A

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#cfc,stroke:#333,stroke-width:2px
```

## NATデバイスはどこにあるのか

NATデバイスと記述されていますが、この装置は物理的に存在するというよりは、ルーター(L3スイッチ)に組み込まれるソフトウェア実装が大半です。
ただし大規模な装置の場合、ワイヤロジック化された専用ハードウェアを持つ場合もあります。

```{mermaid}
graph TD
    
    subgraph プライベートネットワーク
        A["内部サーバー (192.168.1.10)"]
        subgraph "ルーター(L3スイッチ)"
            B[NATデバイス]
        end
    end
    C[インターネット]

    A -- リクエスト --> B
    B -- Translate (192.168.1.10 -> 203.0.113.10) --> C
    C -- 応答 --> B
    B -- Translate (203.0.113.10 -> 192.168.1.10) --> A

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#cfc,stroke:#333,stroke-width:2px
```



## プロキシサーバーの利用 (歴史的経緯)

初期のインターネット接続では、限られたグローバルIPアドレスを効率的に利用するため、NATデバイスの代わりにプロキシサーバーが利用されることもありました。プロキシサーバーは、内部ネットワークのクライアントからのリクエストを代理で外部に送信し、その応答をクライアントに返す役割を担います。

### 特徴

*   **特定プロトコルの仲介**: 主にHTTPなどの特定のプロトコルに特化して動作します。すべての通信を透過的に変換するNATとは異なります。
*   **キャッシュ機能**: 頻繁にアクセスされるコンテンツをキャッシュすることで、ネットワークの負荷を軽減し、応答速度を向上させることができます。
*   **アクセス制御**: 内部からの外部へのアクセスを制御したり、フィルタリングを行ったりすることが可能です。
*   **グローバルIPアドレスの節約**: 複数のクライアントが1つのプロキシサーバーを介してインターネットにアクセスするため、グローバルIPアドレスの節約に貢献します。

### NATとの違い

プロキシサーバーはアプリケーション層で動作するのに対し、NATはネットワーク層で動作します。NATはIPアドレスとポート番号を透過的に変換しますが、プロキシサーバーは特定のアプリケーションプロトコルを理解し、そのプロトコルに沿って通信を中継します。これにより、より詳細な制御やキャッシュなどの付加価値を提供できます。

```{mermaid}
graph TD
    subgraph プライベートネットワーク
        A["クライアント (192.168.1.10)"]
    end
    Router[ルーター]
    subgraph Router
        Proxy[プロキシサーバー]
    end
    C[インターネット]

    A -- リクエスト --> Proxy
    Proxy -- 代理リクエスト --> C
    C -- 応答 --> Proxy
    Proxy -- 代理応答 --> A

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style Router fill:#bbf,stroke:#333,stroke-width:2px
    style Proxy fill:#bbf,stroke:#333,stroke-width:2px
    style C fill:#cfc,stroke:#333,stroke-width:2px
```

プロキシサーバーを使うことの副次的なメリットとして、『キャッシュ』の効果が当時それなりにありました。
しかし、現在では利用者ごとにカスタム化されたページも多く、恩恵にはあまりあずかれないことが多いです。
また、セキュリティ(SSL/TLS)で保護されたページも多くなりました。そのため、プロキシサーバーの効果も非常に薄くなっています。
さらに、プロキシサーバーは利用するクライアント側でも設定が必要です。プロキシサーバーのアドレスとポート番号を指定するなど、ユーザーにとっては手間がかかることもあります[^wpad]。

こういったことから、現代ではかなり縮小傾向にあるのも事実です。これに『とどめを刺した』感があるのが、次に登場するNAPTの登場です。

[^wpad]: ただし、WPAD (Web Proxy Auto-Discovery Protocol) を利用することで、プロキシサーバーの設定を自動化することも可能です。DHCPサーバーが追加情報として配布する環境もありましたが、こちらも現在ではあまり使われていなそうです。

## NAPT (Network Address Port Translation) / IPマスカレード

NAPTは、IPアドレスだけでなくポート番号も変換することで、1つのグローバルIPアドレスを複数のプライベートIPアドレスを持つデバイスで共有する方式です。これは『IPマスカレード』とも呼ばれ、家庭や小規模オフィスで最も一般的に利用されています。

### ポート番号の重要性

NAPTでは、内部のデバイスからの通信を識別するために、送信元ポート番号を変換します。これにより、NATデバイスは外部からの応答パケットがどの内部デバイス宛てであるかを正確に判断できます。

### 多対一の変換

*   **多対1の変換**: 複数のプライベートIPアドレスを持つデバイスが、たった1つのグローバルIPアドレスを共有できます。
*   **IPアドレスの節約効果が高い**: グローバルIPアドレスの節約に最も貢献します。
*   **外部からの直接アクセスは困難**: ポート番号も変換されるため、外部から特定の内部デバイスに直接アクセスすることは非常に困難です。ただし、ポートフォワーディング(静的NAPT)を設定することで、特定のポートへのアクセスを内部の特定のデバイスに転送することは可能です。

```{mermaid}
graph TD
    subgraph プライベートネットワーク
        A["内部ホスト 1 (192.168.1.10:10000)"]
        B["内部ホスト 2 (192.168.1.11:20000)"]
    end
    C["NATデバイス (203.0.113.1:80)"]
    D[インターネット]

    A -- リクエスト --> C
    C -- Translate (192.168.1.10:10000 -> 203.0.113.1:50000) --> D
    B -- リクエスト --> C
    C -- Translate (192.168.1.11:20000 -> 203.0.113.1:50001) --> D

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#bbf,stroke:#333,stroke-width:2px
    style D fill:#cfc,stroke:#333,stroke-width:2px
```

## NAT-PT (NAT Protocol Translation)

NAT-PTは、IPv4とIPv6のアドレス変換を行うための技術です。これは、IPv4ネットワークとIPv6ネットワークが混在する環境で、両者間の通信を可能にするために考案されました。しかし、現在ではIPv6への移行が進み、より効率的なデュアルスタックやトンネリング技術が主流となっているため、あまり利用されていません。参考として知っておくと良いでしょう。

```{note}
NAPTは呼ばれ方がいろいろあります。家庭向けや法人向けのルーターでも、パッケージ記載の名称にはそれなりに『揺れ』があります。

- NAPT
- NAT-P
- PNAT
- IPマスカレード(Masquerade)

おおむね『ポート』を示すPが入っているのでわかるのですが、マスカレードという表現は少し独特ですね。
実はNAPTの考え方の有名になった実装が、"IP Masquerade"という名前でLinuxに実装されたことが由来です。

詳しく調べ切れていませんが、カーネル1.3.66(1996年リリース、Linux 2.0向けの開発版)において実装が追加およびドキュメントに文言が含まれているようです。
また、1997年11月発行の"Linux Journal"においても、IPマスカレードの概念が紹介されています。

```
