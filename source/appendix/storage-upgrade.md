# ストレージを増やす方法

ここまで、Linux環境での練習を行ってきましたが、ストレージが不足しているということが頻繁に起きております。
そこで今回は仮想マシンにおける「ストレージの増加」について説明します。
`.vscode*`ディレクトリにデータが残りすぎる問題もありますが、今後のことも考えて、容量自体を増やす方法についての解説となります。

## 作業前の準備(スナップショット)

作業の前に、現在のVMの状況を後で復元できるよう、スナップショットを取得しておきましょう。
失敗しても復元処理で戻せるようになります。

1. VirtualBoxのメニューで、VMを選んでスナップショットのメニューアイコンをクリックします。
    ```{figure} images/select-snapshot.png
    :width: 75%
    ```
2. 『最新の状態』を右クリックして『作成』を選択します。
    ```{figure} images/snapshot-create.png
    :width: 50%
    ```
3. スナップショットにわかりやすい名前を設定して進めます。
    ```{figure} images/set-name.png
    :width: 50%
    ```
これでスナップショットが作成されるので、なにか問題があればスナップショットを選んで『復元』ができるようになります。
スナップショットが確認できたら、通常通りVMを起動して次のステップ(増量)に進めましょう。

## ストレージの追加手順

vscode(リモート)で接続後、ターミナルで状況の確認をします。

```bash
$ df -h
```

この時点でのルート(`/`)のサイズを確認しておいてください。
今回授業で配布しているVMでは、`btrfs`というファイルシステムが使われています。
このファイルシステムは、従来の`ext4`などと異なり、ストレージの拡張が比較的簡単に行えます。

### 未使用のボリュームを確認する

授業配布のVMでは、ストレージ、すなわちディスクイメージを多少小分けで配布しており、未使用のイメージが存在します。
これをまず確認してみましょう。このために、`lsblk`コマンドを使います。

```bash
$ sudo lsblk
[sudo] password for linux:
NAME            MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
sda               8:0    0     2G  0 disk
├─sda1            8:1    0   487M  0 part /boot
├─sda2            8:2    0     1K  0 part
└─sda5            8:5    0   1.5G  0 part
  └─system-root 254:0    0   3.5G  0 lvm  /
sdb               8:16   0     2G  0 disk
└─sdb1            8:17   0     2G  0 part
  └─system-root 254:0    0   3.5G  0 lvm  /
sdc               8:32   0     2G  0 disk
sdd               8:48   0     2G  0 disk
sr0              11:0    1  1024M  0 rom
zram0           253:0    0 491.8M  0 disk [SWAP]
```

この出力の読み方です。
- `sda`や`sdb`がディスク全体を示しています
- `sda1`や`sdb1`がそのディスク内のパーティションを示しています
  - そのため子要素のようにツリー表示になっています
- 実際に現在利用されているパーティションやボリュームは`TYPE`や`MOUNTPOINTS`で確認できます

たとえば`sdc`や`sdd`はパーティションのない未使用ディスクであることがわかります。
`sda`や`sdb`はすでにパーティションが設定されており、何らかの用途(パーティション自体がマウントされている、LVM化されているなど)で使われていることがわかります。

ここでは例として、パーティションの作成されていない素の`sdc`を追加してみたいと思います。

```{note}
繰り返しますが、仮想マシン(VM)的にはディスクに見えていますが、ホスト(WindowsやmacOS)側から見たらただのファイルです。
```

### ボリュームの追加

それでは、`sdc`をルート(`/`)に追加してみましょう。本来であればLVMのための処理などが必要ですが、`btrfs`の場合はbtrfsの管理下に追加するだけで終了します。

```{code-block}
:language: bash

$ df -h / # before
Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/system-root  3.6G  1.7G  1.5G  54% /          # 残量1.5GB

$ sudo btrfs dev add /dev/sdc /                           # デバイス追加

$ df -h /
Filesystem               Size  Used Avail Use% Mounted on
/dev/mapper/system-root  5.6G  1.7G  3.5G  33% /          # 残量3.5GB(+2GB)
```

上記のように、`btrfs dev add`コマンドで追加したいデバイスを指定し、マウントポイント(`/`)を指定するだけで完了です。
`df -h /`で確認すると、ルートのサイズが増えていることが確認できればこれで完了です。
一度VMを終了し、現在の状態でスナップショットを再度取得すると安心感が増すでしょう。
